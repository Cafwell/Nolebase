
```R
library(tidyverse)
library(vroom)
library(ggplot2)
```

# 线性模型Linear model (LM)

首先要获取数据，查看head，并查找、去除NA值
```R
wages <- vroom("https://raw.githubusercontent.com/perlatex/R_for_Data_Science/master/demo_data/wages.csv")

wages %>%
  head() # show several lines
---
    earn   height      sex   race   ed age
   <dbl>    <dbl>   <chr>   <chr> <dbl> <dbl>
79571.30	73.89	male	white	16	49
96396.99	66.23	female	white	16	62
48710.67	63.77	female	white	16	33
80478.10	63.22	female	other	16	95
82089.35	63.08	female	white	17	43
15313.35	64.53	female	white	15	30


wages %>% colnames() # Know the meaning of each variable
---
"earn"   "height"  "sex"   "race"   "ed"    "age" 

wages %>%
summarise_all(
    ~ sum(is.na(.)) # check NA values. can also use `map_df(~ sum(is.na(.)))`
  )
---
# A tibble: 1 × 6
   earn height   sex  race    ed   age
  <int>  <int> <int> <int> <int> <int>
1     0      0     0     0     0     0
```

其中n() 函数是一个与摘要函数 summarize() 配合的计数函数，它不需要任何参数，单独使用时，它计算的就是行计数。

Simple statistics for variables
```R
wages %>% count(race)
wages %>%
  group_by(sex) %>%
  summarise(
    n = n(), # n() gives the current group size
    mean_height = mean(height),
    mean_earn = mean(earn)
  )
---
# A tibble: 2 × 4
  sex        n mean_height mean_earn
  <chr>  <int>       <dbl>     <dbl>
1 female   859        64.5    24246.
2 male     520        70.0    45993.
```

```R
wages %>%
  ggplot(aes(x = age, y = earn)) +
  geom_point(aes(color = sex))
```
![[../../assets/Data Analysis/lm1.png|500]]

## 线性回归模型
简单，广泛！（非线性可以由线性近似；多元时线性拟合更好）

The taller you are, the more money you make?   
To answer this question, we introduce linear models. As the name implies, is that
$$y = \alpha + \beta x + \varepsilon $$
其中$\varepsilon$为误差。

We usually use ordinary least squares (OLS) regression, in R:
> lm(formula = y ~ x, data)   # ~ symbol for “Prediction”

```R
ggplot(data = wages) + geom_point(aes(x = height, y = earn), alpha = 0.6) + geom_smooth(aes(x = height, y = earn), method = "lm", se = FALSE)

mod1 <- lm(formula = earn ~ height, data = wages)
```
![[../../assets/Data Analysis/lm2.png|500]]

解读summary(mod1)：
```R result
Call:
lm(formula = earn ~ height, data = wages)  # 公式部分

Residuals:  # 残差，真实数据-预测数据
   Min     1Q Median     3Q    Max 
-47903 -19744  -5184  11642 276796 

Coefficients:  # 系数
            Estimate Std. Error t value Pr(>|t|)    
(Intercept)  -126523      14076  -8.989   <2e-16 ***   # α
height          2387        211  11.312   <2e-16 ***   # β
---
Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

# 有星号（*）即表明小于0.05

Residual standard error: 29910 on 1377 degrees of freedom  # 对ϵ的估计
Multiple R-squared:  0.08503, Adjusted R-squared:  0.08437 # R方，简单模型时与p-value有决定性关系，系数显著时R^2也很大
F-statistic: 128 on 1 and 1377 DF,  
p-value: < 2.2e-16 # 整个模型的p-value，在简单线性模型中与上面的p无区别
```

+ 是否统计显著要看 t/p-value 或者星号的数量，而不是系数绝对值大小；
+ 是否科学显著要看绝对值数大小（每改变一单位x，y期望的变化）。

> PS：不带截距项：lm(earn ~ height + 0, data = wages) ，但一般不用。

## 多重线性回归 (Multiple linear regression)
$$
Y = \alpha + \beta_{1}X_{i} + ... +  \beta_{p}X_{ip} + \varepsilon
$$
we add new predictor variables!

为什么要引入多元？  
简单一元模型不够好，解释、预测能力等弱

```R
mod2 <- lm(formula = earn ~ height + ed, data = wages)
print(mod2) # R给出截距和斜率
---
Call:
lm(formula = earn ~ height + ed, data = wages)

Coefficients:
(Intercept)       height           ed  
    -161541         2087         4118  


summary(mod2)
---
Call:
lm(formula = earn ~ height + ed, data = wages)

Residuals:
   Min     1Q Median     3Q    Max 
-63031 -17079  -3589  10488 258760 

Coefficients:
             Estimate Std. Error t value Pr(>|t|)    
(Intercept) -161541.5    13539.1  -11.93   <2e-16 ***
height         2087.2      200.3   10.42   <2e-16 ***
ed             4118.0      313.6   13.13   <2e-16 ***

Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 28210 on 1376 degrees of freedom
Multiple R-squared:  0.1869,	Adjusted R-squared:  0.1857 
F-statistic: 158.2 on 2 and 1376 DF,  p-value: < 2.2e-16


wages %>% modelr::add_predictions(mod2) # View the fit value
---
# A tibble: 1,379 × 7
     earn height sex    race        ed   age   pred
    <dbl>  <dbl> <chr>  <chr>    <dbl> <dbl>  <dbl>
 1 79571.   73.9 male   white       16    49 58571.
 2 96397.   66.2 female white       16    62 42583.
 3 48711.   63.8 female white       16    33 37449.
 4 80478.   63.2 female other       16    95 36301.
 5 82089.   63.1 female white       17    43 40126.
 6 15313.   64.5 female white       15    30 34917.
 7 47104.   61.5 female white       12    53 16322.
 8 50960.   73.3 male   white       17    50 61437.
 9  3213.   72.2 male   hispanic    15    25 51009.
10 42997.   72.4 male   white       12    30 38989.
# … with 1,369 more rows
# ℹ Use `print(n = ...)` to see more rows
```

若继续增加变量，观察summary可以发现一些现象：
+ 此时整个模型的显著程度区别于每个变量的显著程度
+ Multiple R-squared随着变量增加始终提升
+ Adjusted R-squared并不一定，暗示变量不是越多越好

```R
mod_all <- lm(formula = earn ~ ., data = wages)
summary(mod_all)
---
Call:
lm(formula = earn ~ ., data = wages)  # 'earn ~ .'表示earn以外的所有

Residuals:
   Min     1Q Median     3Q    Max 
-61942 -15937  -3087  10757 253465 

Coefficients:
              Estimate Std. Error t value Pr(>|t|)    
(Intercept)  -89820.65   18471.73  -4.863 1.29e-06 ***
height          632.74     275.72   2.295   0.0219 *  
sexmale       17552.54    2139.65   8.203 5.32e-16 ***
racehispanic  -2086.07    3947.50  -0.528   0.5973    
raceother      -377.75    5625.71  -0.067   0.9465    
racewhite      2506.72    2555.94   0.981   0.3269    
ed             4382.09     305.17  14.359  < 2e-16 ***
age             287.47      47.32   6.075 1.60e-09 ***

Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 27180 on 1371 degrees of freedom
Multiple R-squared:  0.2477,	Adjusted R-squared:  0.2439 
F-statistic: 64.49 on 7 and 1371 DF,  p-value: < 2.2e-16
```

### 模型修正（技巧）
以自带数据框mtcars为例子：

#### Update
update()函数可以帮助模型的修正
```R
mod_plus = update(mod, . ~ . + cyl)

mod_minus = update(mod, . ~ . - am)

mod_log = update(mod, log(.) ~ .)

# 波浪左边的点表示原模型 ~ 左边的所有元素，波浪右边同理；可以添加、减去变量或对Y取log()
```

#### 交叉
如果感觉现有模型不够好，可以考虑加入交叉项
```R
mod1 = lm(mpg ~ hp + wt + am, data = mtcars)
mod_cross = update(mod, . ~ . + am * wt, data = mtcars)
summary(mod_cross)
---
Call:
lm(formula = mpg ~ hp + wt + am + wt:am, data = mtcars)

Residuals:
    Min      1Q  Median      3Q     Max 
-3.0639 -1.3315 -0.9347  1.2180  5.0822 

Coefficients:
             Estimate Std. Error t value Pr(>|t|)    
(Intercept) 30.947333   2.723411  11.363 8.55e-12 ***
hp          -0.026949   0.009796  -2.751  0.01048 *  
wt          -2.515586   0.844497  -2.979  0.00605 ** 
am          11.554813   4.023277   2.872  0.00784 ** 
wt:am       -3.577910   1.442796  -2.480  0.01968 *  

Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 2.332 on 27 degrees of freedom
Multiple R-squared:  0.8696,	Adjusted R-squared:  0.8503 
F-statistic: 45.01 on 4 and 27 DF,  p-value: 1.451e-11
```

##### 交叉的意义
在这个数据里，X2 (am)为0或1的类别值，那么这种交叉，使得其他变量对不同分组存在不同影响：
$$
\begin{gathered}
  Y = {\beta _0} + {\beta _1}{X_1} + {\beta _2}{X_2} + {\beta _3}{X_1}{X_2} \hfill \\
  \\
  {X_2} = 1:Y = {\beta _0} + {\beta _2} + \left( {{\beta _1} + {\beta _3}} \right){X_1} \hfill \\
  {X_2} = 0:Y = {\beta _0} + {\beta _1}{X_1} \hfill \\ 
\end{gathered} 
$$
由与交叉的引入，使得$\beta_{3}$的存在，让两式X1的系数不同了，即斜率有所区别

### 共线性
部分变量互相相关甚至严格相关 (如y=2x)时，则这两个变量会互相影响导致估计误差很大！

例：
```R
mod_car <- lm(mpg ~ ., data = mtcars)
summary(mod_car)
---
Call:
lm(formula = mpg ~ ., data = mtcars)

Residuals:
    Min      1Q  Median      3Q     Max 
-3.4506 -1.6044 -0.1196  1.2193  4.6271 

Coefficients:
            Estimate Std. Error t value Pr(>|t|)  
(Intercept) 12.30337   18.71788   0.657   0.5181  
cyl         -0.11144    1.04502  -0.107   0.9161  
disp         0.01334    0.01786   0.747   0.4635  
hp          -0.02148    0.02177  -0.987   0.3350  
drat         0.78711    1.63537   0.481   0.6353  
wt          -3.71530    1.89441  -1.961   0.0633 .
qsec         0.82104    0.73084   1.123   0.2739  
vs           0.31776    2.10451   0.151   0.8814  
am           2.52023    2.05665   1.225   0.2340  
gear         0.65541    1.49326   0.439   0.6652  
carb        -0.19942    0.82875  -0.241   0.8122  

Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

Residual standard error: 2.65 on 21 degrees of freedom
Multiple R-squared:  0.869,	Adjusted R-squared:  0.8066 
F-statistic: 13.93 on 10 and 21 DF,  p-value: 3.793e-07
```
发现总模型p-value为3.793e-07<0.05，而所有变量p值都大于0.05，不显著。因为里面很多变量都是相关性很高的。


### 变量重要性？ - 选择模型
**Which variable has the greatest impact on Y?**

有多种方法，没有最优的说法。

#### AIC - Akaike information criterion 
```R
step(mod_car)
---
Start:  AIC=70.9
mpg ~ cyl + disp + hp + drat + wt + qsec + vs + am + gear + carb

       Df Sum of Sq    RSS    AIC
- cyl   1    0.0799 147.57 68.915
- vs    1    0.1601 147.66 68.932
- carb  1    0.4067 147.90 68.986
- gear  1    1.3531 148.85 69.190
- drat  1    1.6270 149.12 69.249
- disp  1    3.9167 151.41 69.736
- hp    1    6.8399 154.33 70.348
- qsec  1    8.8641 156.36 70.765
<none>              147.49 70.898
- am    1   10.5467 158.04 71.108
- wt    1   27.0144 174.51 74.280

Step:  AIC=68.92
mpg ~ disp + hp + drat + wt + qsec + vs + am + gear + carb

       Df Sum of Sq    RSS    AIC
- vs    1    0.2685 147.84 66.973
- carb  1    0.5201 148.09 67.028
- gear  1    1.8211 149.40 67.308
- drat  1    1.9826 149.56 67.342
- disp  1    3.9009 151.47 67.750
- hp    1    7.3632 154.94 68.473
<none>              147.57 68.915
- qsec  1   10.0933 157.67 69.032
- am    1   11.8359 159.41 69.384
- wt    1   27.0280 174.60 72.297

Step:  AIC=66.97
mpg ~ disp + hp + drat + wt + qsec + am + gear + carb

       Df Sum of Sq    RSS    AIC
- carb  1    0.6855 148.53 65.121
- gear  1    2.1437 149.99 65.434
- drat  1    2.2139 150.06 65.449
- disp  1    3.6467 151.49 65.753
- hp    1    7.1060 154.95 66.475
<none>              147.84 66.973
- am    1   11.5694 159.41 67.384
- qsec  1   15.6830 163.53 68.200
- wt    1   27.3799 175.22 70.410

Step:  AIC=65.12
mpg ~ disp + hp + drat + wt + qsec + am + gear

       Df Sum of Sq    RSS    AIC
- gear  1     1.565 150.09 63.457
- drat  1     1.932 150.46 63.535
<none>              148.53 65.121
- disp  1    10.110 158.64 65.229
- am    1    12.323 160.85 65.672
- hp    1    14.826 163.35 66.166
- qsec  1    26.408 174.94 68.358
- wt    1    69.127 217.66 75.350

Step:  AIC=63.46
mpg ~ disp + hp + drat + wt + qsec + am

       Df Sum of Sq    RSS    AIC
- drat  1     3.345 153.44 62.162
- disp  1     8.545 158.64 63.229
<none>              150.09 63.457
- hp    1    13.285 163.38 64.171
- am    1    20.036 170.13 65.466
- qsec  1    25.574 175.67 66.491
- wt    1    67.572 217.66 73.351

Step:  AIC=62.16
mpg ~ disp + hp + wt + qsec + am

       Df Sum of Sq    RSS    AIC
- disp  1     6.629 160.07 61.515
<none>              153.44 62.162
- hp    1    12.572 166.01 62.682
- qsec  1    26.470 179.91 65.255
- am    1    32.198 185.63 66.258
- wt    1    69.043 222.48 72.051

Step:  AIC=61.52
mpg ~ hp + wt + qsec + am

       Df Sum of Sq    RSS    AIC
- hp    1     9.219 169.29 61.307
<none>              160.07 61.515
- qsec  1    20.225 180.29 63.323
- am    1    25.993 186.06 64.331
- wt    1    78.494 238.56 72.284

Step:  AIC=61.31
mpg ~ wt + qsec + am

       Df Sum of Sq    RSS    AIC
<none>              169.29 61.307
- am    1    26.178 195.46 63.908
- qsec  1   109.034 278.32 75.217
- wt    1   183.347 352.63 82.790

Call:
lm(formula = mpg ~ wt + qsec + am, data = mtcars)

Coefficients:
(Intercept)           wt         qsec           am  
      9.618       -3.917        1.226        2.936
```
该方法逐步删去使得AIC值最小变量（AIC越小，拟合程度越好），直到AIC不减反增，给出最终模型：`lm(mpg ~ wt + qsec + am, data = mtcars)`

反之，亦可以从头加起来创造最好模型：
```R
mod0 <- lm(mpg ~ 1, data = mtcars)
biggest = formula(lm(mpg ~ ., data = mtcars))
step(mod0, direction = "forward", scope = biggest)
---
Start:  AIC=115.94
mpg ~ 1

       Df Sum of Sq     RSS     AIC
+ wt    1    847.73  278.32  73.217
+ cyl   1    817.71  308.33  76.494
+ disp  1    808.89  317.16  77.397
+ hp    1    678.37  447.67  88.427
+ drat  1    522.48  603.57  97.988
+ vs    1    496.53  629.52  99.335
+ am    1    405.15  720.90 103.672
+ carb  1    341.78  784.27 106.369
+ gear  1    259.75  866.30 109.552
+ qsec  1    197.39  928.66 111.776
<none>              1126.05 115.943

Step:  AIC=73.22
mpg ~ wt

       Df Sum of Sq    RSS    AIC
+ cyl   1    87.150 191.17 63.198
+ hp    1    83.274 195.05 63.840
+ qsec  1    82.858 195.46 63.908
+ vs    1    54.228 224.09 68.283
+ carb  1    44.602 233.72 69.628
+ disp  1    31.639 246.68 71.356
<none>              278.32 73.217
+ drat  1     9.081 269.24 74.156
+ gear  1     1.137 277.19 75.086
+ am    1     0.002 278.32 75.217

Step:  AIC=63.2
mpg ~ wt + cyl

       Df Sum of Sq    RSS    AIC
+ hp    1   14.5514 176.62 62.665
+ carb  1   13.7724 177.40 62.805
<none>              191.17 63.198
+ qsec  1   10.5674 180.60 63.378
+ gear  1    3.0281 188.14 64.687
+ disp  1    2.6796 188.49 64.746
+ vs    1    0.7059 190.47 65.080
+ am    1    0.1249 191.05 65.177
+ drat  1    0.0010 191.17 65.198

Step:  AIC=62.66
mpg ~ wt + cyl + hp

       Df Sum of Sq    RSS    AIC
<none>              176.62 62.665
+ am    1    6.6228 170.00 63.442
+ disp  1    6.1762 170.44 63.526
+ carb  1    2.5187 174.10 64.205
+ drat  1    2.2453 174.38 64.255
+ qsec  1    1.4010 175.22 64.410
+ gear  1    0.8558 175.76 64.509
+ vs    1    0.0599 176.56 64.654

Call:
lm(formula = mpg ~ wt + cyl + hp, data = mtcars)

Coefficients:
(Intercept)           wt          cyl           hp  
   38.75179     -3.16697     -0.94162     -0.01804
```
得到了新的模型`lm(formula = mpg ~ wt + cyl + hp, data = mtcars)`

#### BIC - Bayesian Information Criterion
```R
step(mod_car, k = log(n))
```
类似与AIC

#### Anova
统计意义上论证某些变量是否可以去除还需要模型比较:
比较一个full model (mod_car)和一个reduced model (经过AIC/BIC之后的模型)
```R
reduced_mod <- lm(formula = mpg ~ wt + qsec + am, data = mtcars)
anova(reduced_mod, mod_car)
---
Analysis of Variance Table

Model 1: mpg ~ wt + qsec + am
Model 2: mpg ~ cyl + disp + hp + drat + wt + qsec + vs + am + gear + carb
  Res.Df    RSS Df Sum of Sq      F Pr(>F)
1     28 169.29                           
2     21 147.49  7    21.791 0.4432 0.8636
```
Pr = 0.8636 >> 0.05，那么表明删去是没有统计学影响的！

## 附：A physical interpretation of linear models
线性模型可以类比为，这里有一根通过这个均值点的刚体，而每个数据点都是一个弹簧，竖直连接到刚体，最后的状态就是线性回归的直线。

![springs|400](https://bookdown.org/wangminjie/R4DS/images/Least_squares_as_springs.png)

![Spring|400](https://i0.wp.com/www.enchufa2.es/wp-content/uploads/2020/12/pca.gif?zoom=1.25&w=450&ssl=1)