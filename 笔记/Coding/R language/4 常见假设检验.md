# 均值检验 

## 学生t检验 - Student's t-test：
> 由 19 世纪末的一位酿酒师戈塞特推导出的方法，因其发表研究成果时用的笔名为 “学生”，这一方法被称作是 student’s T 检验，虽有其名，但使用者却未必是学生。

简称t检验（t test），通过**小样本**（例如 n<30）来对**总体均值或者总体之间均值的差异的推断**，用于统计量服从正态分布，但方差未知的情况。

1. 理论来说t-test依赖正态性假设
2. 但由中心极限定理，大样本也可以用

t-test 的类型：
-   one-sample t-test，用来比较单个样本平均值和一个给定的平均值（理论值）；
-   independent samples t-test (unpaired two sample t-test)，用来比较两组独立样本平均值；
-   paired t-test，用来比较两个相关样本组之间的平均值；

### 单样本情况
+ H0: 样本均值与总体均值相等（想要拒绝的）
+ H1: 样本均值与总体均值不等
设定检验均值为n     
`p值 > 0.05`，接收原假设，即均值为n

假如我们使用机器制造直径为 10.01mm 的零件，最近制造的一批零件有20个，我们想要知道这批零件的均值（m）和理论均值μ=10.01是否有明显差异，也就是说生成的这批零件是否符合规格。

R中使用 rnorm 函数生成符合正态分布的一组随机数:   
`rnorm(n, mean, sd)`
+ n:要生成随机数的数量
+ mean:要生成该组随机数的平均值
+ sd:要生成改组随机数的标准差
```R
set.seed(233)
sample <- rnorm(30, mean = 10, sd = 0.05 )
head(sample)
[1] 10.044807 10.036622  9.984592  9.952429  9.982188 10.065807
```
原假设（Null hypothesis）：   
H0: m = μ 该批零件均值m等于理论均值μ。   
备择假设（Alternative hypothesis）：   
H1: m ≠ μ 该批零件均值不等于理论均值μ；   
H1: m > μ 该批零件均值大于理论均值μ；   
H1: m < μ 该批零件均值小于理论均值μ。  

> H0 : m = μ；H1 : m ≠ μ（双尾）
```R
t.test(sample, mu = 10.01)
```
![](https://pic1.zhimg.com/80/v2-df9608ea81cefd0902753f6ff877225c_720w.webp)

t = 0.47，自由度 df = n-1 =29，因为 p-value = 0.64 大于 0.05，所以差异不显著，所以接受原假设，认为该批零件直径的均值与理论均值相等，生产的零件符合标准。

> H0 : m = μ；H1 : m > μ（单尾） 
```R
t.test(sample, mu = 9.9, alternative = "greater")
```
从上面的双尾 t-test 看出，如果理论均值 μ = 10.01，那么该批零件符合标准。这里我们进行单尾 t-test，备择假设该批零件直径的均值 m 大于理论均值 μ，设置理论均值为 μ = 9.9。
![](https://pic2.zhimg.com/80/v2-64c10f091c006ec400cea006f81278a5_720w.webp)

p-value < 0.05，所以拒绝原假设，认为该批零件直径均值显著大于理论均值 9.9。

### 双样本
+ H0: μ1=μ2
+ H1: μ1≠μ2
`p值 > 0.05`，不显著，即表明两个数据**平均值相等**
`p值 < 0.05`，拒绝原假设，两个均值不同

```R
data(mtcars)
attach(mtcars)
wt_am = wt[am == 0]
wt_mn = wt[am == 1]
t.test(wt_am, wt_mn) # 双样本t检验，p>0.05则表明两个数据平均值不等
---
Welch Two Sample t-test

data:  wt_am and wt_mn
t = 5.4939, df = 29.234, p-value = 6.272e-06
alternative hypothesis: true difference in means is not equal to 0
95 percent confidence interval:
 0.8525632 1.8632262
sample estimates:
mean of x mean of y 
 3.768895  2.411000
```

### t检验包的代码实现
```R
install.packages("rstatix")
library(rstatix)

our_test <- grouped_data %>%
              t_test(values~group, detailed=T) %>%
              add_significance() ##return the significances too
our_test
---
# A tibble: 1 × 16
estimate estimate1 estimate2 .y. group1 group2  n1 n2 stati…¹  p   df conf.…²
<dbl> <dbl> <dbl> <chr>  <chr>  <chr>  <int> <int>   <dbl>    <dbl> <dbl>   <dbl>    -14.3  161.  175. values femal… males   100   100   -18.0 1.11e-43  198.   -15.8
# … with 4 more variables: conf.high <dbl>, method <chr>, alternative <chr>, p.signif <chr>,
#   and abbreviated variable names ¹​statistic, ²​conf.low
# ℹ Use `colnames()` to see all variable names
```


# 方差检验

检验两组样本方差是否相同，基本只用f-test：
```R
var.test(wt_am, wt_mn)
---
F test to compare two variances

data:  wt_am and wt_mn
F = 1.5876, num df = 18, denom df = 12, p-value = 0.4177
alternative hypothesis: true ratio of variances is not equal to 1
95 percent confidence interval:
 0.5107978 4.3959133
sample estimates:
ratio of variances 
          1.587613
```

p-value = 0.4177 > 0.05，无法拒绝，认为相同。

PS:  这个检验基于正态性假设且极其敏感


# 相关性检验
```R
cor.test(x, y)
```


# 正态检验

## 正态W检验法 Shapiro-Wilk
```R
shapiro.test(values)
---
Shapiro-Wilk normality test

data:  wt
W = 0.94326, p-value = 0.09265
```
显著水平大于 0.05，认为符合正态分布；   
*但光有值不够*，要结合图来看

## qqplot
以3中的grouped_data为例，安装ggpubr包
```R
install.packages("ggpubr")
library(ggpubr)
ggqqplot(grouped_data, x="values", color="group")
```
![[../../assets/Data Analysis/ggplot8.png|500]]

看起来数据严格遵循直线，因此(连同我们之前看到的直方图)这表明数据可能是正态分布的。

# 卡方检验

## 单变量
用于检验概率是否均匀：   
本质是刻画观测数据与期望数据的差距，如果卡方值越大，二者偏差程度越大；反之，二者偏差越小；若两个值完全相等时，卡方值就为 0，表明理论值完全符合。通用式：

$$
\chi ^2 = \sum \frac{{\left | observed - expected \right |}^2}{expected} 
$$
+ observed: 观察频数  
+ expected: 理论频数

> 当 n>40, 但理论频数大于 1 且小于 5 时，此时计算卡方值的通用公式需要进行校正，或者用 fisher 精确检验，在 R 语言中的函数为 fisher.test()

```R
x = c(210, 312, 170, 85, 223) # 期望为200
chisq.test(x, correct = F) # 参数 correct, 它默认的就是 TRUE，即进行卡方值修正
---
Chi-squared test for given probabilities

data:  x
X-squared = 136.49, df = 4, p-value < 2.2e-16
```


## 双变量
举例说明，探究一下感冒与喝牛奶之间是否有关联（检验两个变量是否独立），由于是两个变量，可以将原始数据转换为四格卡方值做四格卡方检验：

|        | 感冒 | 不感冒 |
| ------ | ---- | ------ |
| 喝牛奶 | 95   | 25     |
| 不喝的 | 15   | 85     |

根据观察频数表求得感冒率：感冒人数 / 总人数 = 110/220=0.5，即感冒率就是 0.5，则理论频数表为：

|        | 感冒 | 不感冒 |
| ------ | ---- | ------ |
| 喝牛奶 | 60   | 60     |
| 不喝的 | 50   | 50     |

理论值无小于 5，可以直接使用卡方：
```R
cold <- c(95,15,25,85)
y <- matrix(cold,nrow=2)
chisq.test(y, correct=F)
---
Pearson’s Chi-squared test

data:  y
X-squared = 89.833, df = 1, p-value < 2.2e-16
```
p值远小于显著性水平0.05，拒绝原假设：感冒与喝牛奶没有关系

要注意，该检验仅能说明存在相关性而**非因果性**。