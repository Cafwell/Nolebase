
# 广义线性混合模型 (*GLMM*)

## 统计学知识

 **“混合”** 一词指的是除了回归分析的通常固定效应之外的随机效应。
+ 固定效应（fixed effect, FE）
+ 随机效应（random effect, RE）

固定效应和随机效应的区别就在于如何看待参数。
+ 对于固定效应来说，参数变化，引起应变量平均变化。
+ 对于随机效应而言，参数是服从正态分布的一个随机变量，也就是说对于两个相同自变量，对应变量的影响不一定是相同的。

对于固定部分我们得到的是模型参数的点估计，对于随机部分我们得到的是其概率分布。

![[../../assets/Coding/FE and RE.png]]

-  普通线性模型（以只有一个因变量举例）：  
    $$y = \beta_0 +\beta_1 * x + ε$$或  
$$Y=\mathbf X\beta + ε$$
    也就是**固定效应 + 随机误差**，且因变量必须要满足**正态性、独立性以及方差齐性**。

+ 而广义线性模型（GLM）可以为：
	$$log(\frac{P(y=1)}{1-P(y=1)})=\beta_0 + \beta_1 * x_1+ ε$$
	或
	$$log(y) = \beta_0 + \beta_1 * x_1+ ε$$
GLM 之所以称为 “广义”，关键就在于这种变换 —— 连接函数（就是上边两个等式左边），使得模型的应用范围变得更宽，只要因变量服从指数分布就行；

线性混合模型（LMM）则形如（以矩阵形式表示）：
$$Y = \mathbf X\beta + \mathbf Z \gamma + ε$$

相较普通线性模型，LMM 其实就是多了随机效应*Zγ* ！


### 什么时候用 GLMM
1.  适用于层级，多水平数据；
2.  重复测量，非独立，或时间 - 空间 的数据

### 随机的类型
随机效应有两种 ：   
随机斜率 -    
![[../../assets/Coding/random slopes.png|350]]

随机截距 -    
![[../../assets/Coding/random intercepts.png|350]]

### 随机部分的写法
![[../../assets/random_of_glmm.png]]

一般是一和五两种写法，例：

> wear~wheel+(1|car_type)
   wear~wheel+(wheel|car_type)
   
+ 前者意义是提供随机斜率；另一种意义是提供随机斜率和随机截距。
+ 可以简单的把 "（）" 内的内容看为随机部分 ，"（）" 前面的是固定部分 。随机部分 "|" 左边的提供随机斜率 ，左边写 1 即没有随机斜率，右边提供随机截距
+ 后者中，"|" 左边的预测变量，必须也在固定部分出现 

### 嵌套；交叉
数据可能有一个或多个聚类来源，而且聚类可能是分层的，比如聚类是嵌套在其他聚类中。一个例子是对学生进行多次的学术能力测试（重复观察嵌套在学生中，学生嵌套在学校中，学校嵌套在地区中）。

在其他情况下，不存在嵌套结构。一个例子是反应时间实验，参与者执行同一组任务。虽然观察结果是在个人内部嵌套的，但观察结果也是根据任务类型进行聚类的。

可以用`嵌套 (Nested)`和`交叉 (Crossed)`这两个术语来区分这些情况。此外，聚类可能是平衡的或不平衡的。

嵌套图例：  
![[../../assets/Coding/Nested.png|500]]

交叉：   
![[../../assets/Coding/Crossed.png|500]]

## R语言

仍以实验数据为分析材料
```R
library(vroom)
ball <- vroom("https://raw.githubusercontent.com/ExperimentalConservation/Bioinformatics_data/master/IBT/all_groups_data.csv")
ball$Species[which(ball$Species == "dark pink")] <- "darkpink"
ball$Species[which(ball$Species == "darkgreen")] <- "teal"
ball$Species[which(ball$Species == "lightgreen")] <- "green"
head(ball)
---
# A tibble: 6 × 7
  Group_name Thrower     Attempt Species  Bucket Distance Success
  <chr>      <chr>         <dbl> <chr>     <dbl>    <dbl>   <dbl>
1 BY         Yilong Yang       1 teal          5      2         0
2 BY         Yilong Yang       2 yellow        5      0.5       1
3 BY         Yilong Yang       3 green         1      1         0
4 BY         Yilong Yang       4 orange        5      0.5       1
5 BY         Yilong Yang       5 darkpink      5      0.5       1
6 BY         Yilong Yang       6 orange        5      2         1   
```

考虑模型：`number_of_species ~ Distance + Bucket`

安装`fitdistrplus` - 用于判断数据是否服从某一分布
```R
install.packages('fitdistrplus')
library(fitdistrplus)
```

```R
library(tidyverse)

fit_pois <- grouped$Species_count %>% fitdist('pois', method = "mle")
plot(fit_pois)
```
![[../../assets/Data Analysis/fitdist.png|500]]
```R
gofstat(fit_pois)
---
Chi-squared statistic:  2.988494 
Degree of freedom of the Chi-squared distribution:  3 
Chi-squared p-value:  0.3934026 
   the p-value may be wrong with some theoretical counts < 5  
Chi-squared table:
     obscounts theocounts
<= 3  5.000000   3.151330
<= 4  4.000000   2.676861
<= 5  3.000000   3.127701
<= 7  3.000000   5.587036
> 7   4.000000   4.457072

Goodness-of-fit criteria
                               1-mle-pois
Akaike’s Information Criterion   99.41076
Bayesian Information Criterion  100.35520
```
可见p值0.39 > 0.05，观测值和预期值之间没有显著差异，符合泊松分布

检验其他潜在分布模型：
```R
fit_nbinom <- fitdist(grouped$number_of_species,
                      dist = 'nbinom')
##plot it out:
plot(fit_nbinom)
```
![[../../assets/Data Analysis/fitdist1.png|500]]

安装`glmmTMB`
```R
install.packages('glmmTMB')
library(glmmTMB)
```

```R
# 泊松分布模型
m_mod1 <- glmmTMB(Count ~
                    Bucket +
                    Distance +
                    # Bucket:Distance +  数据较小，可以不用此行
                    (1|Group_name),
                  data = grouped,
                  family = "poisson",
            control=glmmTMBControl(optimizer=optim,optArgs=list(method="BFGS")))

# 负二项分布模型
m_mod2 <- glmmTMB(Count ~
                    Bucket +
                    Distance +
                    #Bucket:Distance +
                    (1|Group_name),
                  data = grouped,
                  family = "nbinom1", control=glmmTMBControl(optimizer=optim, optArgs=list(method="BFGS")))
```

使用MuMIn 下面的 `r.squaredGLMM()` 函数来求其 R2 (R2即拟合度，一般来说，_R_-_Squared_ 越大，表示模型拟合效果越好)
```R
install.packages('MuMIn')
library(MuMIn)
r.squaredGLMM(m_mod1)
---
                R2m       R2c
delta     0.4912718 0.5406309
lognormal 0.5092221 0.5603847
trigamma  0.4717288 0.5191244

r.squaredGLMM(m_mod2)
---
                R2m       R2c
delta     0.4911331 0.5400752
lognormal 0.5091479 0.5598852
trigamma  0.4715176 0.5185050
```


### 评估 GLMM 模型的拟合度

`DHARMa`包能提供更稳健的方式评估：
```R
# simulateResiduals方法创建模拟残差
m_mod1_sim <- simulateResiduals(m_mod1, n = 1000)
m_mod2_sim <- simulateResiduals(m_mod2, n = 1000)
plot(m_mod1_sim)
plot(m_mod2_sim)
```
![[../../assets/Data Analysis/m_mod1_sim.png|400]]
![[../../assets/Data Analysis/m_mod2_sim.png|400]]

```R
testDispersion(m_mod1)
testDispersion(m_mod2)
```