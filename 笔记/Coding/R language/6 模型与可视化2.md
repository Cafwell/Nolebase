# 线性回归模型诊断

## 检查模型是否可靠
线性回归的 **LINE** 假设:
![[../../assets/Coding/LINE.png|450]]

Shown in one picture will be like:
![[../../assets/Coding/LINE_illustrated.png|500]]

## 误差
由于误差要符合正态分布，实际中使用残差来估计误差并检验！
$${\hat \varepsilon _i} = {\hat y_i} - {y_i}$$
即：
1. 均值为0 - 残差均匀分布在0的两侧
2. 正态分布 - qqplot
3. 同分布（方差相同）
4. ~~独立性（但一般不检验）~~

## R可视化检验

```R
mod <- lm(formula = mpg ~ wt, data = mtcars)
# par(mfrow=c(2,2))  四张图同时以2x2显示
plot(mod)
```

### 残差图：
![[../../assets/Data Analysis/plot_1.png|400]]
均值为0的图，尽量拟合中间的虚线；   
方差相同的图，点分布宽度相似；
对于此图，可以表明对于15-25的范围内，误差分布比较好。

### QQplot 
![[../../assets/Data Analysis/plot_2.png|400]]
数据正态的图，点分布在虚线直线上；
对于此图，在 (-1,1)上，分布比较符合

或用`shapiro.test(mod$residuals)`
```
Shapiro-Wilk normality test

data:  mod$residuals
W = 0.94508, p-value = 0.1044  # > 0.05!!
```

## 模型有误的处理
1. 检查线性型是否有误，并考虑对变量做变换（很多非线性模型都可以通过变换转化为线性模型）
$$
\begin{gathered}
  y = k{e^{ax}} \Leftrightarrow \log y = ax + \log k \hfill \\
  y = {x^k} \Leftrightarrow \log y = k\log x \hfill \\ 
\end{gathered} 
$$
2. 检查是否有离群值影响因子很大的数据点，考虑剔除（<font color="#ff0000">谨慎</font>，输错还是数据本身异常？）；简单线性回归请画图检验
3. 多元线性? - 使用Leverage score (Hat values) 或者Cook's diatance


# 广义线性模型 - Generalized linear model

**“广义”** 一词指的是响应变量的非正态分布，换言之，广义模型包含了非正态因变量：
+ 结果变量（因变量）为类别型：包括二值变量（是 / 否、通过 / 失败、存活 / 死亡）和多类别变量（优 / 良 / 可 / 差）等。
-  结果变量为计数型的（一周交通事故的数目、每日酒水消耗的数量），这类变量都是非负的有限值，它们的均值和方差通常都是相关的（而正态分布变量间则是相互独立）

## In R

使用 `glm ()` 函数构建广义线性模型：
```R
glm(
  formula, 
  family=family(link=function), 
  data=data
)
```

一些常用家族:
1. family=binomial(link="logit") --- Response variable for two values (0 and 1)
$$log_{e}(\frac{\pi}{1-\pi}) = \beta_0 + \sum_{j=1}^{p}\beta_{j}X_{j}$$
2. family=poisson(link="log") ---- A situation in which the response variable is the number of events that occur within a given time
$$log_{e}(\lambda) = \beta_0 + \sum_{j=1}^{p}\beta_{j}X_{j}$$
3. family=gaussian(link="identity") ---- Standard linear regression, a special case of generalized linear regression
$$\mu_{Y} = \beta_0 + \sum_{j=1}^{p}\beta_{j}X_{j}$$

```R
modlogit = glm(am ~ wt, family = binomial, data = mtcars)
plot(x = mtcars$wt, y = modlogit$fitted.values)
```
![[../../assets/Data Analysis/logit.png|400]]
可以发现，y轴表示了概率，车重为3左右时，0.5的可能是是手动挡。

## 🐧的数据（from package）
```R
library(palmerpenguins) 
data(penguins)
head(penguins)
---
# A tibble: 6 × 8
  species island    bill_length_mm bill_depth_mm flipper_length_mm body_mass_g sex     year
  <fct>   <fct>              <dbl>         <dbl>             <int>       <int> <fct>  <int>
1 Adelie  Torgersen           39.1          18.7               181        3750 male    2007
2 Adelie  Torgersen           39.5          17.4               186        3800 female  2007
3 Adelie  Torgersen           40.3          18                 195        3250 female  2007
4 Adelie  Torgersen           NA            NA                  NA          NA NA      2007
5 Adelie  Torgersen           36.7          19.3               193        3450 female  2007
6 Adelie  Torgersen           39.3          20.6               190        3650 male    2007
```

绘box图：
```R
penguins %>%
  ggplot(aes(x = species, y = flipper_length_mm)) +
  
  # outlier为异常值，可以设定形状与颜色
  geom_boxplot(aes(col = species), outlier.colour="red", outlier.shape=8) +
  
  # 设置数据抖动
  geom_jitter(aes(col = species), alpha = 0.5, shape=16, position = position_jitter(0.3)) +
  
  # stat_summary, 可以用于添加均值点
  stat_summary(fun="mean", geom="point", shape=10, size=6, color="black") +
  theme_minimal()
```
![[../../assets/Data Analysis/glm1.png|500]]
可见三组数据之间有显著性差异。
> 何为显著性差异？数据之间具**有了显著性差异**，就说明参与比对的数据**不是**来自于**同一总体**（Population），而是来自于具有差异的两个不同总体。

由于是正态分布，采用上述第三种，即特殊化GLM——或者称一般的LM：
```R
mod_flipper <- glm(flipper_length_mm ~ species,
            ##specify the data
            data = penguins,
            ##specify the error structure
            family = "gaussian")
summary(mod_flipper)
---
Call:
glm(formula = flipper_length_mm ~ species, family = "gaussian", 
    data = penguins)

Deviance Residuals: 
     Min        1Q    Median        3Q       Max  
-17.9536   -4.8235    0.0464    4.8130   20.0464  

Coefficients:
                 Estimate Std. Error t value Pr(>|t|)    
(Intercept)      189.9536     0.5405 351.454  < 2e-16 ***
speciesChinstrap   5.8699     0.9699   6.052 3.79e-09 ***
speciesGentoo     27.2333     0.8067  33.760  < 2e-16 ***

Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1

(Dispersion parameter for gaussian family taken to be 44.1099)

    Null deviance: 67427  on 341  degrees of freedom
Residual deviance: 14953  on 339  degrees of freedom
  (2 observations deleted due to missingness)
AIC: 2270.6

Number of Fisher Scoring iterations: 2
```

### 多重比较检验
multcomp包提供了方法：
```R
library(multcomp)

# ### Tukey HSD检验，该包还可以实现Dunnett方法
T <- glht(mod_flipper, mcp(species="Tukey"))
summary(T)
---
	 Simultaneous Tests for General Linear Hypotheses

Multiple Comparisons of Means: Tukey Contrasts

Fit: glm(formula = flipper_length_mm ~ species, family = "gaussian", 
    data = penguins)

Linear Hypotheses:
                        Estimate Std. Error z value Pr(>|z|)    
Chinstrap - Adelie == 0   5.8699     0.9699   6.052 2.63e-09 ***
Gentoo - Adelie == 0     27.2333     0.8067  33.760  < 1e-09 ***
Gentoo - Chinstrap == 0  21.3635     1.0036  21.286  < 1e-09 ***

Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
(Adjusted p values reported -- single-step method)


par(mar=c(4,8,3,3)) # plot显示不完全，设置边缘空白大小，第二个值为左右宽
plot(T)
```
![[../../assets/Data Analysis/glm2.png|500]]


## ⚾的数据（实验）
```R
ball <- vroom("https://raw.githubusercontent.com/Cafwell/Bioinformatics_data/master/IBT/all_groups_data.csv")

levels(as.factor(ball$Species))
---
[1] "dark pink"  "darkblue"  "darkgreen"  "darkpink"  "green"  "lightblue" 
[7] "lightgreen" "lightpink" "orange"     "purple"    "red"    "teal"      
[13] "yellow" 
```

整理：
```R
ball$Species[which(ball$Species == "dark pink")] <- "darkpink"
ball$Species[which(ball$Species == "dark green")] <- "teal"
ball$Species[which(ball$Species == "light green")] <- "green"
levels(as.factor(ball$Species))
---
[1] "darkblue"  "darkpink"  "green"     "lightblue" "lightpink" "orange"   
[7] "purple"    "red"       "teal"      "yellow" 
```

```R
grouped_1 <- ball %>%
  group_by(Group_name,
           Bucket,
           Distance) %>%
  filter(Success == 1) %>%
  summarise(Count = n())
head(grouped_1)
---
# A tibble: 6 × 4
# Groups:   Group_name, Bucket [4]
  Group_name      Bucket Distance Count
  <chr>            <dbl>    <dbl> <int>
1 Albert Lukatima      1      0.5    10
2 Albert Lukatima      1      1.5     3
3 Albert Lukatima      5      2       5
4 Albert Lukatima      5      2.5     3
5 BY                   1      1       7
6 BY                   5      0.5    12
```